<!DOCTYPE html>
<html lang="en">
<head>
    <title>WarsawJS Meetup: Debugging memory leaks</title>

    <meta charset="utf-8"/>
    <meta http-equiv="x-ua-compatible" content="ie=edge"/>
    <meta name="viewport" content="width=device-width"/>
    <link href="images/icons/warsawjs-logo-transparent-32x32.png" rel="icon" type="image/png" sizes="32x32"/>

    <link href="https://fonts.googleapis.com/css?family=Fira+Sans:400,900&amp;subset=latin-ext" rel="stylesheet"/>

    <!-- Shower Theme -->
    <link rel="stylesheet" href="vendors/shower-ribbon/styles/screen-16x9.css"/>
    <link rel="stylesheet" href="vendors/shower-warsawjs/styles/main.css"/>

    <!-- Prism.js -->
    <link rel="stylesheet" href="vendors/prism/prism.css"/>
    <link rel="stylesheet" href="vendors/prism/custom-prism.css"/>

    <!-- my additions -->
    <link rel="stylesheet" href="styles/my-theme.css">
</head>
<body class="shower list">
    <header class="caption">
        <h1>WarsawJS Meetup: Debugging memory leaks</h1>
        <p>We talk about JavaScript. Each month in Warsaw, Poland.</p>
    </header>

    <section class="slide front-page">
        <div class="logo">
            <!-- Logo WarsawJS -->
            <img src="vendors/shower-warsawjs/images/logo.svg" width="350" alt=""/>
        </div>
        <div class="details">
            <!-- 1. Avatar -->
            <img src="images/mg.png" alt="Speaker" width="200"/>

            <!-- 2. Speaker -->
            <h2>Maciej Go≈Çaszewski</h2>

            <!-- 3. Presentation title -->
            <h2><strong>"WarsawJS Meetup: Debugging memory leaks" [EN]</strong></h2>

            <!-- 4. Presentation date -->
            <h2>2019-12-12</h2>

            <!-- 5. Contact the speaker -->
            <h2><a href="http://twitter.com/jodator">@jodator</a></h2>
        </div>
    </section>

    <section class="slide compact">
        <h2>Memory management in JavaScript</h2>
        <p>JavaScript automatically allocates memory when objects are created.</p>
        <p>It also automatically frees memory when those objects are no longer used in a process called <i>garbage collection</i></p>

        Automaticity - when/why? (confusion) ([img](https://i.imgflip.com/2slo9z.png)) Sup! The JavaScript will handle this for me! Wrong!
    </section>

    <section class="slide compact">
        <h2>JavaScript Memory life-cycle</h2>
        <h3>in 3 easy steps</h3>

        <ol>
            <li class="next">allocate</li>
            <li class="next">use</li>
            <li class="next">release</li>
        </ol>
    </section>

    <section class="slide compact">
        <h2>Step 1: Allocate</h2>

        <p>JavaScript automatically allocate memory when values are initially declared:</p>

        <ul>
            <li>primitives like <code>Number</code> or <code>String</code></li>
            <li>for <code>Object</code> & <code>Array</code> - for the object/array and contained values</li>
            <li>Function declaration (<code>() => {}</code>) allocates a callable object (<code>Function</code>)</li>
            <li>Object creation <code>new Foo()</code>, <code>new Date()</code>, etc...</li>
            <li>Element creation - <code>document.createElement( 'div' )</code></li>
            <li>array and string methods like <code>array.concat( otherArray )</code>, <code>'JavaScript'.substr( 0, 4 )</code></li>
        </ul>

    </section>

    <section class="slide compact">
        <h2>Step 2: Use</h2>

        <p>...</p>
    </section>

    <section class="slide compact">
        <h2>Step 3: Release</h2>

        <p>How do Garbage Collector decides if some memory is not needed anymore?</p>

        Reference - one object reference another if the former has access to the latter (implicitly or explicitly).

        - implicitly - ie to its prototype
        - to its properties values

        <p>This means that object in memory management is considered with it function or lexical scope (so what's visible in current
            position
            in execution stack).</p>
        <!-- TODO -->
        ## How JavaScript detects memory to free?

        Meet the "Mark-and-sweep algorithm"

        IMG

        The "object no longer needed" is an "unreachable object".

        We assume well-known set of objects "roots". In JavaScript it is the *global* object (AKA window).

        The M&S periodically start from a root and find all objects referenced from these roots, then objects referenced by these and so on.

        When going from root to all objects the Garbage Collector will find all non-reachable.

        All modern browsers comes with mark-and-sweep garbage collector (with some improvements - but the general idea of an object that is
        no longer need stays the same.

        function foo() {
        const x = "foo";
        return "baz";
        }

        foo();
    </section>

    <section class="slide compact">
        <h2>Releasing the memory</h2>
        <blockquote>
            <p>As of 2019 We cannot release memory manually (call garbage collector).</p>
        </blockquote>

        <p>That's true, but:</p>
        <ul>
            <li>In Node.js you can increase heap memory <code>node --max-old-space-size=9001 index.js</code>.</li>
            <li>For Chrome there's <code>--expose gc</code> flag for exposing <code>window.gc()</code> method.</li>
        </ul>
    </section>

    <section class="slide compact">
        <h2>Common causes of memory leaks</h2>

        <ul>
            <li>globals</li>
            <li>globals!</li>
            <li>shared lexical scope</li>
            <li>forgotten callbacks</li>
            <li>forgotten DOM nodes</li>
        </ul>
    </section>

    <section class="slide compact">
        <h2>Tools - how to find memory leaks</h2>

        <ul>
            <li>Google Chrome dev tools - memory tab</li>
            <li>Firefox dev tool - memory tab</li>
            <li><code>window.performance.memory</code></li>
        </ul>
    </section>

    <section class="slide prism">
        <h2>Memory leaks: Accidental global</h2>
        <pre style="font-size: 30px;" class="language-javascript line-numbers">
            <code>
                document.getElementById( 'ml-global' )
                    .addEventListener( 'click', () => {
                        // window.bo = new BigObject();
                        // bo = new BigObject();
                        this.bo = new BigObject(); // this === window
                    } );
            </code>
        </pre>
        <a href="demo.html" target="_blank" rel="noopener noreferrer">Demo</a>
    </section>

    <section class="slide prism">
        <h2>Memory leaks: Intermediate values</h2>
        <pre style="font-size: 30px;" class="language-javascript line-numbers">
            <code>
                const config = {
                    bo: new BigObject(), // used somewhere else
                    foo: 'bar',
                    interval: 1000
                };

                logSomething( config );

                function logSomething( config ) {
                    // Also don't forget your intervals!
                    setInterval( () => {
                        console.log( config.foo );
                    }, config.interval );
                }
            </code>
        </pre>
        <a href="demo.html" target="_blank" rel="noopener noreferrer">Demo</a>
    </section>

    <section class="slide prism">
        <h2>Memory leaks: Shared lexical scope</h2>
        <pre style="font-size: 30px;" class="language-javascript line-numbers">
            <code>
                let theThing = null;

                function replaceThing() {
                    const originalThing = theThing;

                    function unused() {
                        if ( originalThing ) {
                            console.log( 'Hello there!' );
                        }
                    }

                    theThing = {
                        bo: new BigObject(),
                        someMethod: function() {
                            console.log( 'Some method...' );
                        }
                    };
                }
            </code>
        </pre>
        <a href="demo.html" target="_blank" rel="noopener noreferrer">Demo</a>
    </section>

    <section class="slide prism">
        <h2>Memory leaks: Forgotten DOM nodes</h2>
        <pre style="font-size: 30px;" class="language-javascript line-numbers">
            <code>
                const myStuff = {};

                document.getElementById( 'ml-forgotten-dom' ).addEventListener( 'click', () => {
                    const button = document.createElement( 'input' );
                    button.type = 'button';
                    button._bo = new BigObject();

                    myStuff.button = button;

                    document.body.appendChild( button );

                    button.addEventListener( 'click', removeButton );

                    function removeButton() {
                        document.body.removeChild( document.getElementById( 'click-me' ) );
                        button.removeEventListener( 'click', removeButton );
                    }
                } );
            </code>
        </pre>
        <a href="demo.html" target="_blank" rel="noopener noreferrer">Demo</a>

        <p class="reference">Ref: <a href="https://blog.meteor.com/an-interesting-kind-of-javascript-memory-leak-8b47d2e7f156"
                                     target="_blank" rel="noopener noreferrer">An interesting kind of JavaScript memory leak</a>.</p>
    </section>

    <section class="slide prism">
        <h2>Memory leaks: Forgotten stuff...</h2>
        <pre style="font-size: 30px;" class="language-javascript line-numbers">
            <code>
                const bo = new BigObject();
                const node = document.getElementById( 'a-div' );

                function detachNode() {
                    node.remove();
                }

                setInterval( () => {
                    console.log( bo[ 3 ] );
                }, 500 );

                console.log( bo );
            </code>
        </pre>
        <a href="demo.html" target="_blank" rel="noopener noreferrer">Demo</a>
    </section>

    <section class="slide compact">
        <h2>ProTips‚Ñ¢</h2>

        <ul>
            <li>be careful with anonymous functions for callbacks (if scope is shared)</li>
            <li>pass only what you need - big objects - retentions</li>
            <li>de-register callbacks</li>
            <li>consider using `WeakMap` instead of `Map`</li>
            <li>GC must pause execution to collect garbage - so if you experience lags - it might be this.</li>
            <li>if in doubt - measure</li>
            <li>when testing - disable all addons</li>
        </ul>
    </section>

    <section class="slide prism">
        <h2>Disabling addons - Chrome</h2>

        <pre>
            <code class="language-javascript line-numbers">
            google-chrome \
                --enable-precise-memory-info \
                --disable-extensions \
                --disable-plugins \
                --incognito
                http://example.com</code>
        </pre>
    </section>

    <section class="slide prism">
        <h2>Disabling addons - Firefox</h2>

        <pre>
            <code class="language-javascript line-numbers">
            firefox \
                -P "empty" \
                --new-instance \
                --safe-mode \
                http://localhost:8125
            </code>
        </pre>
    </section>

    <section class="slide">
        <h3 class="shout">Thanks!</h3>
    </section>

    <div class="progress"></div>

    <footer class="badge">
        <a href="https://github.com/jodator/warsawjs-debugging-memory-leaks">Fork me on GitHub</a>
    </footer>

    <footer class="badge badge-top-left">
        <a href="#" class="fullscreen">Fullscreen</a>
    </footer>

    <script src="vendors/gamepad/gamepad.js"></script>
    <script src="vendors/shower/shower.min.js"></script>
    <script src="vendors/shower-gamepad/shower.gamepad.js"></script>
    <script src="vendors/shower-warsawjs/scripts/fullscreen.js"></script>

    <!-- Prism.js -->
    <script src="vendors/prism/prism.js"></script>
    <script src="vendors/prism/custom-prism.js"></script>
</body>
</html>
